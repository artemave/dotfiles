#!/usr/bin/env bash
set -euo pipefail

uid="$(id -u)"
host_socket="/tmp/tmux-${uid}/default"
container_root="${TMUX_CONTAINER_ROOT:-/tmp/tmux-containers}"

lines=""
if [[ -S "$host_socket" ]]; then
  while IFS= read -r session; do
    lines+="host:${session}"$'\t'"$host_socket"$'\t'"$session"$'\n'
  done < <(tmux -S "$host_socket" list-sessions -F "#{session_name}" 2>/dev/null || true)
fi

if [[ -d "$container_root" ]]; then
  while IFS= read -r -d '' socket; do
    container_name="$(basename "$(dirname "$(dirname "$socket")")")"
    while IFS= read -r session; do
      lines+="container:${container_name}:${session}"$'\t'"$socket"$'\t'"$session"$'\n'
    done < <(tmux -S "$socket" list-sessions -F "#{session_name}" 2>/dev/null || true)
  done < <(find "$container_root" -maxdepth 3 -path "*/tmux-${uid}/default" -type s -print0 2>/dev/null)
fi

tmux_width="$(tmux display-message -p '#{window_width}')"
tmux_height="$(tmux display-message -p '#{window_height}')"
tmux_popup_size="85%,80%"
if [[ "$tmux_width" -lt 120 || "$tmux_height" -lt 40 ]]; then
  tmux_popup_size="95%,90%"
fi

selection=$(printf "%s" "$lines" \
  | sed '/^$/d' \
  | fzf --tmux="$tmux_popup_size" --ansi --prompt="tmux> " \
      --delimiter=$'\t' --with-nth=1 \
      --preview 'socket={2}; session={3}; tmux -S "$socket" capture-pane -pt "$session" -e -S -200 2>/dev/null' \
      --preview-window=right:60%,follow \
  || true)

if [[ -z "${selection}" ]]; then
  exit 0
fi

IFS=$'\t' read -r display socket name <<< "$selection"
scope=${display%%:*}
current_socket=""
if [[ -n "${TMUX-}" ]]; then
  current_socket="${TMUX%%,*}"
fi

case "$scope" in
  host)
    if [[ -n "${TMUX-}" && "$current_socket" == "$socket" ]]; then
      exec tmux switch-client -t "$name"
    fi
    if [[ -n "${TMUX-}" ]]; then
      tmux detach-client -E "tmux -S \"$socket\" attach -t \"$name\""
      exit 0
    fi
    exec tmux -S "$socket" attach -t "$name"
    ;;
  container)
    if [[ -n "${TMUX-}" && "$current_socket" == "$socket" ]]; then
      exec tmux switch-client -t "$name"
    fi
    if [[ -n "${TMUX-}" ]]; then
      tmux detach-client -E "tmux -S \"$socket\" attach -t \"$name\""
      exit 0
    fi
    exec tmux -S "$socket" attach -t "$name"
    ;;
  *)
    echo "tmux-all: unknown selection '$selection'" >&2
    exit 1
    ;;
esac
